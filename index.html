<!DOCTYPE html>
<html class="PrettyNewTab">
  <head>
    <meta charset="utf-8">
    <title>New Tab</title>
    <style>
      /* libs below has been compressed via http://csscompressor.com/ */

      /**
       * https://github.com/cssrecipes/defaults/blob/master/index.css
       */
      html{box-sizing:border-box;overflow:auto;border-collapse:collapse}*,:before,:after{box-sizing:inherit;overflow:inherit}*{border-collapse:inherit}:not(body){background-repeat:no-repeat;background-position:50%;background-size:cover}[hidden]{display:none!important}html,body{margin:0;padding:0}

      /**
       * https://github.com/cssrecipes/reset/blob/master/button.css
       */
      .reset-Button{border:none;margin:0;padding:0;width:auto;overflow:visible;background:transparent;color:inherit;font:inherit;line-height:normal;-webkit-font-smoothing:inherit;-moz-osx-font-smoothing:inherit;-webkit-appearance:none}.reset-Button::-moz-focus-inner{border:0;padding:0}

      /**
       * PrettyNewTab
       */
      .PrettyNewTab,
      .PrettyNewTab body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: black;
      }

      .PrettyNewTab body {
        font-size: 1rem;
        line-height: 1.525rem;

        font-family: "Helvetica Neue", Helvetica, "Lucida Grande", "Lucida Sans Unicode", Arial, sans-serif;
      }

      .PrettyNewTab body,
      .PrettyNewTab a {
        color: #fff;
        text-shadow:
          0 0 0.2rem rgba(0,0,0,.8),
          0 0.05rem 0.4rem rgba(0,0,0,.5),
          0 -0.05rem 0.4rem rgba(0,0,0,.5),
          0.05rem 0 0.4rem rgba(0,0,0,.5),
          -0.05rem 0 0.4rem rgba(0,0,0,.5)
        ;
      }

      .PrettyNewTab small,
      .PrettyNewTab .small { font-size: .8em }

      .PrettyNewTab-icon {
        transform: translate3d(0,0,0); /* fix webkit/blink poor rendering issues */

        display: inline-block;

        /*width: 1em;
        height: 1em;*/
        line-height: 1;
        vertical-align: middle;

        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;

        fill: currentColor;
      }

      .PrettyNewTab-button {
        cursor: pointer;
      }

      .PrettyNewTab-stretch {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      @-webkit-keyframes PrettyNewTab-animation-spin {
        from { -webkit-transform: rotate(0deg); }
        to { -webkit-transform: rotate(360deg); }
      }
      @keyframes PrettyNewTab-animation-spin {
        from {transform:rotate(0deg);}
        to {transform:rotate(360deg);}
      }
      .PrettyNewTab-animate-spin {
          animation: PrettyNewTab-animation-spin .6s infinite linear;
      }

      .PrettyNewTab-loader {
        color: #fff;
        opacity: 1;
      }

      .PrettyNewTab-background {
        background-color: transparent;
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;

        opacity: 1;
        -webkit-transition: opacity .6s;
        transition: opacity .6s;

        /* trigger gpu */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        /* avoid glitch */
        -webkit-backface-visibility: hidden;
      }

      .PrettyNewTab-background--hidden {
        opacity: 0;
      }

      .PrettyNewTab-backgroundOverlay {
        background-color: transparent;
        background-image: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0) 50%,
          rgba(0, 0, 0, .75) 100%
        );
      }

      .PrettyNewTab-pin {
        position: absolute;

        padding: 1rem;
      }

        .PrettyNewTab-pin--top-right { top: 0; right: 0 }
        .PrettyNewTab-pin--bottom-right { bottom: 0; right: 0 }
        .PrettyNewTab-pin--top-left { top: 0; left: 0 }
        .PrettyNewTab-pin--bottom-left { bottom: 0; left: 0 }

        .PrettyNewTab-pin--top { top: 0; left: 0; right; width: 100%; }
        .PrettyNewTab-pin--right { top: 0; right: 0; bottom: 0; height: 100%; }
        .PrettyNewTab-pin--bottom { bottom: 0; left: 0; right; width: 100%; }
        .PrettyNewTab-pin--left { top: 0; bottom: 0; left: 0; height: 100%; }

        .PrettyNewTab-pin--top,
        .PrettyNewTab-pin--bottom { text-align: center }

        .PrettyNewTab-pin--right,
        .PrettyNewTab-pin--left { /* @todo vertical-align */ }

      .PrettyNewTab-time {
        font-size: 1.5rem;
        font-weight: 200;
      }

      .PrettyNewTab-backgroundCredit {
        text-decoration: none
      }
      .PrettyNewTab-backgroundCredit:hover {
        text-decoration: underline
      }

      .PrettyNewTab-footer {

      }

        .PrettyNewTab-footer .PrettyNewTab-footer-txt,
        .PrettyNewTab-footer-link {
          -webkit-transition: opacity .5s;
          transition: opacity .5s;
        }

          .PrettyNewTab-footer-txt { opacity: .25; }

          .PrettyNewTab-footer:hover .PrettyNewTab-footer-txt { opacity: .4; }

        .PrettyNewTab-footer-link {
          opacity: .3;
          text-decoration: none;
        }

          .PrettyNewTab-footer:hover .PrettyNewTab-footer-link { opacity: .5 }
          .PrettyNewTab-footer:hover .PrettyNewTab-footer-link:hover {
            opacity: .75;
            text-decoration: underline;
          }

      .PrettyNewTab-separator {
        font-size: .8em;
        padding: .4rem;
        opacity: .2;
      }
    </style>
  </head>
  <!-- future refactor note: be careful of the added class for each svg -->
  <body>
    <div class="js-PrettyNewTab-loader PrettyNewTab-loader PrettyNewTab-pin PrettyNewTab-pin--top-left">
      <!-- http://iconmonstr.com/loading-2-icon/ -->
      <svg class="PrettyNewTab-icon PrettyNewTab-animate-spin" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path id="loading-2-icon" d="M236,163.117V50h40v113.117c-6.449-1.382-13.139-2.116-20-2.116S242.449,161.735,236,163.117z M227.021,165.509L170.322,67.6l-34.641,20l56.678,97.873C202.248,176.542,214.027,169.667,227.021,165.509z M185.479,192.351 L87.6,135.681l-20,34.641l97.912,56.689C169.672,214.017,176.547,202.24,185.479,192.351z M161,256.001 c0-6.861,0.734-13.551,2.117-20H50v40h113.117C161.734,269.552,161,262.862,161,256.001z M256,351c-5.979,0-11.826-0.559-17.5-1.615 V462h35V349.385C267.828,350.441,261.98,351,256,351z M165.592,285.24L67.6,341.681l20,34.641l98.053-56.475 C176.693,309.98,169.787,298.22,165.592,285.24z M331.289,313.934l96.863,55.893l12.5-21.65l-96.84-55.879 C340.59,300.086,336.361,307.351,331.289,313.934z M290.008,344.725l56.002,97.177l25.98-15l-56.025-97.221 C308.23,335.983,299.484,341.09,290.008,344.725z M192.139,326.334l-56.459,98.068l34.641,20l56.42-98.001 C213.762,342.203,202.002,335.295,192.139,326.334z M350.477,246.001c0.344,3.287,0.523,6.622,0.523,10c0,3.377-0.18,6.713-0.523,10 H462v-20H350.477z M309.602,177.562l56.457-98.197l-12.124-7l-56.436,98.159C301.718,172.577,305.761,174.933,309.602,177.562z  M342.252,216.143l97.266-56.282l-8.5-14.722l-97.26,56.279C337.009,206.04,339.855,210.966,342.252,216.143z"/></svg>
    </div>
    <div class="js-PrettyNewTab-background PrettyNewTab-stretch PrettyNewTab-background PrettyNewTab-background--hidden"></div>
    <div class="PrettyNewTab-stretch PrettyNewTab-backgroundOverlay"></div>

    <div class="PrettyNewTab-stretch PrettyNewTab-ui">
      <time class="js-PrettyNewTab-time PrettyNewTab-time PrettyNewTab-pin PrettyNewTab-pin--top-right"></time>

      <footer class="small PrettyNewTab-footer">
        <div class="PrettyNewTab-pin PrettyNewTab-pin--bottom">
          <span class="PrettyNewTab-footer-txt">Made with ♥︎ by</span>
          <a class="PrettyNewTab-footer-link" href="http://putaindecode.io">putaindecode</a>
        </div>

        <a class="js-PrettyNewTab-backgroundCredit PrettyNewTab-backgroundCredit PrettyNewTab-pin PrettyNewTab-pin--bottom-left"></a>

        <div class="PrettyNewTab-pin PrettyNewTab-pin--bottom-right">
          <!-- http://iconmonstr.com/gear-icon/ -->
          <!-- ref above is icon for futur prefs ui -->

          <button class="reset-Button PrettyNewTab-footer-link PrettyNewTab-button PrettyNewTab-button--icon js-PrettyNewTab-changeBackground">
            <!-- http://iconmonstr.com/refresh-3-icon/ -->
            <svg class="PrettyNewTab-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"> <path id="refresh-3-icon" d="M373.223,142.573l-37.252,37.253c-20.225-20.224-48.162-32.731-79.021-32.731 c-61.719,0-111.752,50.056-111.752,111.776c0,0.016,0-0.016,0,0h43.412l-69.342,69.315L50,258.871h42.514c0-0.008,0,0.006,0,0 c0-90.816,73.621-164.46,164.436-164.46C302.357,94.411,343.467,112.816,373.223,142.573z M462,253.129l-69.268-69.316 l-69.342,69.316h43.412c0,0.016,0-0.017,0,0c0,61.72-50.033,111.776-111.752,111.776c-30.859,0-58.797-12.508-79.021-32.731 l-37.252,37.253c29.758,29.757,70.867,48.162,116.273,48.162c90.814,0,164.436-73.644,164.436-164.459c0-0.007,0,0.008,0,0H462z"/></svg>
          </button>

          <a class="PrettyNewTab-footer-link" href="https://github.com/putaindecode/pretty-new-tab">
            <!-- http://iconmonstr.com/info-2-icon/ -->
            <svg class="PrettyNewTab-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewbox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path id="info-2-icon" d="M255.998,90.001c91.74,0,166.002,74.241,166.002,165.998c0,91.741-74.245,166-166.002,166 c-91.74,0-165.998-74.243-165.998-166C90,164.259,164.243,90.001,255.998,90.001 M255.998,50.001 C142.229,50.001,50,142.229,50,255.999c0,113.771,92.229,206,205.998,206c113.771,0,206.002-92.229,206.002-206 C462,142.229,369.77,50.001,255.998,50.001L255.998,50.001z M285.822,367.567h-57.646V230.6h57.646V367.567z M257,202.268 c-17.522,0-31.729-14.206-31.729-31.73c0-17.522,14.206-31.729,31.729-31.729c17.524,0,31.728,14.206,31.728,31.729 C288.728,188.062,274.524,202.268,257,202.268z"/></svg>
          </a>
        </div>
      </footer>
    </div>
    <script src="images.js"></script>
    <script>
    (function(options) {
      var backgrounds = options.backgrounds
      var preload = true
      var updateInterval = 30 //sec, 0 disable auto update

      var loaderEl = document.querySelector(".js-PrettyNewTab-loader")
      var backgroundEl = document.querySelector(".js-PrettyNewTab-background")
      var backgroundCreditsEl = document.querySelector(".js-PrettyNewTab-backgroundCredit")
      var clockEl = document.querySelector(".js-PrettyNewTab-time");
      var changeBackgroundEl = document.querySelector(".js-PrettyNewTab-changeBackground")

      var timeout

      /**
       * RUN THE SHIT
       *
       * `onload` is used so backgrounds huge list can be listed below, not above.
       * This make code easier to read.
       */
      window.onload = function() {
        startClock()

        loadRandomBackground(function() {
          // loader is useless after first load
          loaderEl.setAttribute("hidden", true)
          
          if (preload) {
            preloadBackgrounds()
          }
        })

        changeBackgroundEl.addEventListener("click", function() {
          changeBackgroundEl.classList.add("PrettyNewTab-animate-spin")
          loadRandomBackground(function() {
            onNextAnimationIteration(changeBackgroundEl, function() {
              changeBackgroundEl.classList.remove("PrettyNewTab-animate-spin")
            })
          })
        })

        // we can"t do that, history API is limited to current domain
        // well we don"t have a domain for file:/// so we are screwed...
        // any idea ?
        // https://github.com/putaindecode/pretty-new-tab/issues/2
        // history.pushState({}, "", "");
      }

      /**
       * load a random background
       */
      function loadRandomBackground(callback) {
        loadBackground(getRandomBackground(), function(item) {
          backgroundEl.classList.add("PrettyNewTab-background--hidden")
          backgroundCreditsEl.innerHTML = ""

          // first time, we already have PrettyNewTab-background--hidden
          // so there is no animation, so there is no need to wait for its end.
          // @todo replace this hacky hack by a smart thing using transitionStart & transitionEnd to update a flag ;)
          if (!backgroundEl.style.backgroundImage) {
            updateBackground(item)
          }
          else {
            onNextTransitionEnd(backgroundEl, function() { updateBackground(item) })
          }

          if (updateInterval) {
            if (timeout) {
              clearTimeout(timeout)
            }

            timeout = setTimeout(loadRandomBackground, updateInterval * 1000)
          }

          if (typeof callback === "function") {
            callback()
          }
        })
      }

      function updateBackground(item) {
        backgroundEl.style.backgroundImage = "url(" + item.url +")"
        backgroundEl.classList.remove("PrettyNewTab-background--hidden")

        var credits = "Credits: " + item.source
        var title = item.title ? item.title : credits

        backgroundCreditsEl.setAttribute("href", item.sourceUrl)
        backgroundCreditsEl.innerHTML = title
        if (credits !== title) {
          backgroundCreditsEl.setAttribute("title", credits)
        }
      }

      /**
       * load a background then execute a callback
       *
       * @param {Object}   item     background object to load
       * @param {Function} callback callback to execute when image is loaded. First arg is the item itself, 2nd is the image object.
       */
      function loadBackground(item, callback) {
        var img = new Image()
        img.src = item.url
        if (typeof callback === "function") {
          img.onload = callback.bind(callback, item, img)
        }
      }

      /**
       * preload all backgrounds
       * one bye one
       * not in parallel
       */
      function preloadBackgrounds() {
        preloadBackground(0)
      }

      /**
       * preload the background at the given index
       * @param {Integer} i index of the background array to load
       */
      function preloadBackground(i) {
        // load next
        if (i < backgrounds.length) {
          loadBackground(backgrounds[i], function(item) {
            console.log("item preloaded", i, item.url)
            preloadBackground(i + 1)
          })
        }
      }

      /**
       * Returns a random integer between min (included) and max (excluded)
       *
       * Using Math.round() will give you a non-uniform distribution
       * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
       */
      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      /**
       * get a random background item
       */
      function getRandomBackground() {
        return backgrounds[getRandomInt(0, backgrounds.length - 1)]
      }

      /**
       * execute callback for the next transitionEnd
       *
       * @param {Object}   el       dom element to look at
       * @param {Function} callback function to execute at the end
       */
      function onNextTransitionEnd (el, callback) {
        onNextAnimationEnd (el, callback, {
          "transition": "transitionend",
          "OTransition": "otransitionend",
          "MozTransition": "transitionend",
          "WebkitTransition": "webkitTransitionEnd"
        })
      }

      /**
       * execute callback for the next animationIteration
       *
       * @param {Object}   el       dom element to look at
       * @param {Function} callback function to execute at the end
       */
      function onNextAnimationIteration(el, callback) {
        onNextAnimationEnd(el, callback, {
          "animation": "animationiteration",
          "OAnimation": "oanimationiteration",
          "MozAnimation": "animationiteration",
          "WebkitAnimation": "webkitAnimationIteration"
        })
      }

      /**
       * execute callback for the next animationEnd
       *
       * @param {Object}   el       dom element to look at
       * @param {Function} callback function to execute at the end
       * @param {Object}   animKeys optional anim keys (used for onNextTransitionEnd())
       */
      function onNextAnimationEnd (el, callback, animKeys) {
        var ani
        var anims = animKeys || {
          "animation": "animationend",
          "OAnimation": "oanimationend",
          "MozAnimation": "animationend",
          "WebkitAnimation": "webkitAnimationEnd"
        }

        var i
        for (i in anims) {
          if (anims.hasOwnProperty(i) && el.style[i] !== undefined) {
            ani = anims[i]
          }
        }

        if (ani) {
          var cb = function() {
            callback()
            el.removeEventListener(ani, cb)
          }
          el.addEventListener(ani, cb, false)
        }
        else {
          setTimeout(callback, 1000) // poor fallback - lol
        }
      }

      /**
       * start the clock
       */
      function startClock() {
        updateClock()

        // do not update each 60sec
        // because you don't know when you started
        // and you can miss a minute if you start at 00:00:40
        setInterval(updateClock, 10 * 1000)
      }

      /**
       * update the clock
       */
      var updateClock = function () {
        var date = new Date()
        var hours = date.getHours().toString()
        var minutes = date.getMinutes().toString()
        clockEl.innerHTML = (hours.length < 2 ? "0" : "") + hours + ":" + (minutes.length < 2 ? "0" : "") + minutes
      }

    })(window.PrettyNewTab)
    </script>
  </body>
</html>
